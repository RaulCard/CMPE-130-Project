<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE HTML>
<html>
  <head>
    <title>Encrypt image with JavaScript</title>
    <meta name="author" content="Jonas ElfstrÃ¶m">
    <style type="text/css">
    span {
       font-family: 'Lucida Sans Unicode';
       color: #000000;
       background: #FFFFFF;
       font-size: 10pt;
    }
    </style>
    <script type="text/javascript" src="2.0.0-crypto-sha1-hmac-pbkdf2-ofb-aes.js"></script>
    <script type="text/javascript" src="2.0.0-crypto-sha1-hmac-pbkdf2-rabbit.js"></script>
  </head>
  <body align="center">
    <span>
      <h1>Encrypt and decrypt HTML5 canvas</h1>
      <br>
      JavaScript <a href="http://en.wikipedia.org/wiki/Advanced_Encryption_Standard">AES</a> encryption and decryption of an image.
      <br>
      <form name="f">
      <b>AES</b><br>
        <input type="button" onclick="var start = (new Date).getTime();encryptAES();this.value='Encrypt ' + ((new Date).getTime() - start) + 'ms'" value="Encrypt">
|       <input type="button" onclick="clear_canvas();" value="Clear">
|       <input type="button" onclick="var start = (new Date).getTime();decryptAES();this.value='Decrypt ' + ((new Date).getTime() - start) + 'ms'" value="Decrypt"><br>
      <br>
      </span>
      <canvas id="leif" width="250" height="250"></canvas><br><br>
      Password: <input id="password" type="text" size="20" value="test"><br><br>
      <input id="ta" name="encrypted"><div id="chars"></div><br><br>
      </form>
      <span>
      <br>
      </span>
      <script type="text/javascript">

  var img = new Image();
  img.src = 'img/user_images/2.jpg';
  var width=250;
  var height=250;
  var ctx, imgd, pix;
  
  img.onload = function() {
    ctx = document.getElementById('leif').getContext('2d');
    ctx.drawImage(img, 0, 0);
    imgd = ctx.getImageData(0,0,width,height);
    pix = imgd.data;
  }

  function clear_canvas() {
    ctx.clearRect(0,0,250,250);
    imgd.data=[];
  }

  function canvasArrToString(a) {
    var s="";
    // Removes alpha to save space.
    for (var i=0; i<pix.length; i+=4) {
      s+=(String.fromCharCode(pix[i]) 
          + String.fromCharCode(pix[i+1]) 
          + String.fromCharCode(pix[i+2]));
    }
    return s;
  }

  function canvasStringToArr(s) {
    var p=[];
    for (var i=0; i<s.length; i+=3) {
      for (var j=0; j<3; j++) {
        p.push(s.substring(i+j,i+j+1).charCodeAt());
      } 
      p.push(255); // Hardcodes alpha to 255.
    }
    return p;
  }

  function encryptAES() {
    var password = document.getElementById('password').value;
    var s=canvasArrToString(pix);
    var encrypted = Krypto.AES.encrypt(s, password);
    document.getElementById('ta').value=encrypted;
    document.getElementById('chars').innerHTML=""+encrypted.length+" characters.";
  }

  function decryptAES() {
    var password = document.getElementById('password').value;
    var arr=canvasStringToArr(Krypto.AES.decrypt(document.getElementById('ta').value, password));
    for (var i=0; i<arr.length; i++) { arr[i]-=0; }
    pix=arr;
    imgd.data=pix;
    ctx.putImageData(imgd,0,0);
    document.getElementById('ta').value="";
  }
    </script>
  </body>
  <footer>
    <script type="text/javascript">
      var gaJsHost = (("https:" == document.location.protocol) ? "https://ssl." : "http://www.");
      document.write(unescape("%3Cscript src='" + gaJsHost + "google-analytics.com/ga.js' type='text/javascript'%3E%3C/script%3E"));
    </script>
    <script type="text/javascript">
        try {
          var pageTracker = _gat._getTracker("UA-4453587-2");
          pageTracker._trackPageview();
        }
        catch(err) {}
    </script>
  </footer>
</html>
